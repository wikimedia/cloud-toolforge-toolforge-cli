__toolforge_complete_command () {
	# adapted from git's bash completion
	local command="$1"
	local completion_func="_toolforge_${command//-/_}"
	if ! declare -f $completion_func >/dev/null 2>/dev/null &&
		declare -f _completion_loader >/dev/null 2>/dev/null
	then
		_completion_loader "toolforge-$command"
	fi

	if declare -f $completion_func >/dev/null 2>/dev/null
	then
		$completion_func
		return 0
	else
		return 1
	fi
}

_toolforge() {
	local cur="${COMP_WORDS[COMP_CWORD]}"

	local had_subcommand=false
	local i=1

	while ((i<$COMP_CWORD)); do
		if [[ "${COMP_WORDS[i]}" != -* ]]; then
			had_subcommand=true
			break
		fi

		((++i))
	done

	if ! $had_subcommand; then
		if [[ $cur == -* ]]; then
			COMPREPLY=($(compgen -W "-d --debug --help --version" -- ${cur}))
		else
			COMPREPLY=($(compgen -W "$($1 _commands)" -- ${cur}))
		fi

		return
	fi

	export TOOLFORGE_CLI=1
	__toolforge_complete_command "${COMP_WORDS[1]}"
}

complete -F _toolforge toolforge
